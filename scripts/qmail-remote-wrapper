#!/usr/bin/env sh
PATH=/bin:/usr/bin:/usr/local/bin

# DKIM and Domainkey signing for Alpine based secopstech/mini-qmail image
# Author: Cagri Ersen <cagri.ersen@secopstech.io)
# Forked from http://qmailrocks.thibs.com/downloads/scripts/qmail-remote


# Set signing variables for the sender domain
DOMAIN=${2##*@}
DKREMOTE="/var/qmail/bin/qmail-remote.orig"

dk_vars () {

if [ -d "/etc/domainkeys/$DOMAIN/default" ]; then
    DKSIGN="/etc/domainkeys/$DOMAIN/default"
    SELECTOR=`cat "/etc/domainkeys/$DOMAIN/selector"`
else
    DKSIGN="/etc/domainkeys/default.domain/default"
    SELECTOR=`cat "/etc/domainkeys/default.domain/selector"`
fi

}

# Get signer keys info as variables
dk_vars

# tmp files
inmsg=`mktemp -p /tmp -t dkin.XXXXXXXXXXXXXXX`
midmsg1=`mktemp -p /tmp -t dkmid1.XXXXXXXXXXXXXXX`
midmsg2=`mktemp -p /tmp -t dkmid2.XXXXXXXXXXXXXXX`
outmsg=`mktemp -p /tmp -t dkout.XXXXXXXXXXXXXXX`

# redirect stdin that generated by qmail to
cat - >"$inmsg"

# sign message with domainkeys
dktest -s "$DKSIGN" -c nofws <"$inmsg" >> "$midmsg1" 2>&1

# set d as $DOMAIN and s as $SELECTOR
sed -i -e 's#; d=.*;#; d='"$DOMAIN"';#g' "$midmsg1"
sed -i -e 's#s=default; #s='"$SELECTOR"'; #g' "$midmsg1"

# change the carriage returns at the end of each line into the newline.
(cat "$midmsg1" "$inmsg" | tr -d '\r') > "$midmsg2"

# sign message with DKIM
libdkimtest -d"$DOMAIN" -y"$SELECTOR" -lt -b2 -z1 -s "$midmsg2" "$DKSIGN" "$outmsg" 2>&1

# change the carriage returns at the end of each line into the newline
# and pipe the out file to qmail-remote.orig
(cat "$outmsg" | tr -d '\r') | "$DKREMOTE" "$@"

retval=$?

#Delete tmp files
rm -f "$inmsg" "$midmsg1" "$midmsg1" "$outmsg"

exit $retval